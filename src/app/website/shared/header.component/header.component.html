<!-- header.component.html -->

<nav class="navbar navbar-expand-lg navbar-light fixed-top">
  <div class="container">
    <!-- Logo -->
    <a class="navbar-brand" routerLink="/home">
      <i class="bi bi-shop-window"></i>
      <span>FashionHub</span>
    </a>

    <!-- Mobile Actions -->
    <div class="mobile-actions d-flex d-lg-none align-items-center">
      @if (authService.isLoggedIn()) {
        <!-- Notifications Dropdown - Mobile -->
        <div class="dropdown notification-dropdown">
          <button
            class="notification-bell"
            type="button"
            data-bs-toggle="dropdown"
            data-bs-auto-close="outside"
          >
            <i class="bi bi-bell"></i>
            <span class="notification-count">3</span>
          </button>
          <div class="dropdown-menu dropdown-menu-end notification-menu">
            <ng-container *ngTemplateOutlet="notificationContent"></ng-container>
          </div>
        </div>

        <!-- Cart Icon - Mobile -->
        <div class="cart-icon" data-bs-toggle="offcanvas" data-bs-target="#cartOffcanvas">
          <i class="bi bi-cart3"></i>
          <span class="cart-badge">3</span>
        </div>
      }

      <button
        class="navbar-toggler"
        type="button"
        data-bs-toggle="offcanvas"
        data-bs-target="#mobileMenu"
      >
        <span class="navbar-toggler-icon"></span>
      </button>
    </div>

    <!-- Desktop Navigation -->
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav mx-auto">
        <li class="nav-item">
          <a class="nav-link" routerLink="/home" routerLinkActive="active">الرئيسية</a>
        </li>
        @if (authService.isAdmin()) {
          <li class="nav-item">
            <a class="nav-link text-danger fw-bold" routerLink="/dashboard">لوحة التحكم</a>
          </li>
        }
        <li class="nav-item">
          <a class="nav-link" href="#men-section">ملابس رجالية</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#women-section">ملابس نسائية</a>
        </li>
      </ul>

      <!-- Desktop Actions -->
      <div class="d-flex align-items-center">
        @if (authService.isLoggedIn()) {
          <!-- Notifications Dropdown - Desktop -->
          <div class="dropdown notification-dropdown">
            <button
              class="notification-bell"
              type="button"
              data-bs-toggle="dropdown"
              data-bs-auto-close="outside"
            >
              <i class="bi bi-bell"></i>
              <span class="notification-count">3</span>
            </button>
            <div class="dropdown-menu dropdown-menu-end notification-menu">
              <ng-container *ngTemplateOutlet="notificationContent"></ng-container>
            </div>
          </div>

          <!-- Cart Icon - Desktop -->
          <div class="cart-icon" data-bs-toggle="offcanvas" data-bs-target="#cartOffcanvas">
            <i class="bi bi-cart3"></i>
            <span class="cart-badge">3</span>
          </div>
        }

        <!-- User Dropdown -->
        <div class="dropdown">
          <a href="#" class="user-dropdown dropdown-toggle" data-bs-toggle="dropdown">
            @if (authService.isLoggedIn()) {
              <img
                [src]="authService.currentUser()?.avatar || 'assets/default-avatar.png'"
                class="rounded-circle user-avatar"
                alt="user"
              />
            } @else {
              <i class="bi bi-person-circle"></i>
            }
          </a>
          <ul class="dropdown-menu dropdown-menu-end shadow border-0">
            @if (authService.isLoggedIn()) {
              <li class="dropdown-header">
                <span class="user-name">{{ authService.currentUser()?.firstName }}</span>
                <span class="user-email">{{ authService.currentUser()?.email }}</span>
              </li>
              <li><hr class="dropdown-divider" /></li>
              <li>
                <a class="dropdown-item" routerLink="/profile">
                  <i class="bi bi-person"></i> حسابي
                </a>
              </li>
              <li>
                <a class="dropdown-item" routerLink="/orders"> <i class="bi bi-bag"></i> طلباتي </a>
              </li>
              <li><hr class="dropdown-divider" /></li>
              <li>
                <button class="dropdown-item text-danger" (click)="handleLogout()">
                  <i class="bi bi-box-arrow-right"></i> تسجيل الخروج
                </button>
              </li>
            } @else {
              <li>
                <a class="dropdown-item" routerLink="/login">
                  <i class="bi bi-box-arrow-in-right"></i> تسجيل الدخول
                </a>
              </li>
              <li>
                <a class="dropdown-item" routerLink="/register">
                  <i class="bi bi-person-plus"></i> إنشاء حساب جديد
                </a>
              </li>
            }
          </ul>
        </div>
      </div>
    </div>
  </div>
</nav>

<!-- Notification Template (Reusable) -->
<ng-template #notificationContent>
  <div class="notification-header">
    <h6 class="notification-title">
      <i class="bi bi-bell-fill"></i>
      الإشعارات
    </h6>
    <button class="mark-read-btn">تحديد الكل كمقروء</button>
  </div>

  <div class="notification-body">
    <!-- Notification Item 1 -->
    <a href="#" class="notification-item unread">
      <div class="notification-icon order">
        <i class="bi bi-bag-check-fill"></i>
      </div>
      <div class="notification-content">
        <p class="notification-text">تم شحن طلبك رقم <strong>#12345</strong></p>
        <span class="notification-time"> <i class="bi bi-clock"></i> منذ 2 ساعة </span>
      </div>
    </a>

    <!-- Notification Item 2 -->
    <a href="#" class="notification-item">
      <div class="notification-icon offer">
        <i class="bi bi-tag-fill"></i>
      </div>
      <div class="notification-content">
        <p class="notification-text">خصم <strong>30%</strong> على الملابس الرجالية</p>
        <span class="notification-time"> <i class="bi bi-clock"></i> منذ 5 ساعات </span>
      </div>
    </a>

    <!-- Notification Item 3 -->
    <a href="#" class="notification-item unread">
      <div class="notification-icon system">
        <i class="bi bi-stars"></i>
      </div>
      <div class="notification-content">
        <p class="notification-text">مجموعة جديدة من الفساتين متاحة الآن</p>
        <span class="notification-time"> <i class="bi bi-clock"></i> منذ يوم </span>
      </div>
    </a>
  </div>

  <a href="#" class="notification-footer">
    عرض جميع الإشعارات
    <i class="bi bi-arrow-left"></i>
  </a>
</ng-template>

<!-- Mobile Menu Offcanvas -->
<div class="offcanvas offcanvas-start" tabindex="-1" id="mobileMenu">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title"><i class="bi bi-shop-window me-2"></i> FashionHub</h5>
    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
  </div>
  <div class="offcanvas-body">
    @if (authService.isLoggedIn()) {
      <div class="mobile-user-info">
        <img
          [src]="authService.currentUser()?.avatar || 'assets/default-avatar.png'"
          class="mobile-user-avatar"
          alt="user"
        />
        <div class="mobile-user-details">
          <span class="mobile-user-name">{{ authService.userFullName() }}</span>
          <span class="mobile-user-email">{{ authService.currentUser()?.email }}</span>
        </div>
      </div>
    }

    <ul class="mobile-nav-list">
      <li>
        <a routerLink="/home" routerLinkActive="active" data-bs-dismiss="offcanvas">
          <i class="bi bi-house"></i> الرئيسية
        </a>
      </li>
      @if (authService.isAdmin()) {
        <li>
          <a routerLink="/dashboard" class="admin-link" data-bs-dismiss="offcanvas">
            <i class="bi bi-speedometer2"></i> لوحة التحكم
          </a>
        </li>
      }
      <li>
        <a href="#men-section" data-bs-dismiss="offcanvas">
          <i class="bi bi-person-standing"></i> ملابس رجالية
        </a>
      </li>
      <li>
        <a href="#women-section" data-bs-dismiss="offcanvas">
          <i class="bi bi-person-standing-dress"></i> ملابس نسائية
        </a>
      </li>
    </ul>

    @if (authService.isLoggedIn()) {
      <div class="mobile-nav-divider"></div>
      <ul class="mobile-nav-list">
        <li>
          <a routerLink="/profile" data-bs-dismiss="offcanvas">
            <i class="bi bi-person-gear"></i> حسابي
          </a>
        </li>
        <li>
          <a routerLink="/orders" data-bs-dismiss="offcanvas">
            <i class="bi bi-bag-check"></i> طلباتي
          </a>
        </li>
      </ul>
      <div class="mobile-nav-divider"></div>
      <button class="mobile-logout-btn" (click)="handleLogout()">
        <i class="bi bi-box-arrow-right"></i> تسجيل الخروج
      </button>
    } @else {
      <div class="mobile-auth-buttons">
        <a routerLink="/login" class="btn btn-primary w-100 mb-2" data-bs-dismiss="offcanvas">
          <i class="bi bi-box-arrow-in-right me-2"></i> تسجيل الدخول
        </a>
        <a routerLink="/register" class="btn btn-outline-primary w-100" data-bs-dismiss="offcanvas">
          <i class="bi bi-person-plus me-2"></i> إنشاء حساب جديد
        </a>
      </div>
    }
  </div>
</div>

<!-- ✅ Cart Offcanvas Sidebar - مُصلح -->
<div class="offcanvas offcanvas-end cart-offcanvas" tabindex="-1" id="cartOffcanvas">
  <div class="offcanvas-header">
    <div class="cart-header-content">
      <h5 class="offcanvas-title">
        <i class="bi bi-cart3"></i>
        عربة التسوق
      </h5>
      <span class="cart-items-count">{{ cartService.itemsCount() }} منتجات</span>
    </div>
    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
  </div>

  <div class="offcanvas-body p-0">
    @if (cartService.isLoading()) {
      <div class="cart-loading">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">جاري التحميل...</span>
        </div>
      </div>
    }

    @if (cartService.isEmpty() && !cartService.isLoading()) {
      <div class="empty-cart">
        <i class="bi bi-cart-x"></i>
        <h6>السلة فارغة</h6>
        <p>لم تقم بإضافة أي منتجات بعد</p>
        <a routerLink="/products" class="btn btn-primary" data-bs-dismiss="offcanvas">
          تصفح المنتجات
        </a>
      </div>
    }

    @if (!cartService.isEmpty() && !cartService.isLoading()) {
      <div class="cart-items-container">
        <!-- ✅ track بالـ _id بدلاً من خصائص اختيارية -->
        @for (item of cartService.items(); track item._id) {
          <div class="cart-item-card">
            <div class="cart-item-image">
              <img [src]="item.image || 'assets/placeholder.png'" [alt]="item.name || ''" />
              <button class="remove-item-btn" title="حذف" (click)="removeItem(item)">
                <i class="bi bi-x"></i>
              </button>
            </div>
            <div class="cart-item-info">
              <h6 class="item-name">{{ item.name }}</h6>
              <div class="item-meta">
                @if (item.color) {
                  <span class="item-color">
                    <!-- ✅ safe access للـ colorCode -->
                    <span class="color-dot" [style.background]="item.colorCode || '#ccc'"></span>
                    {{ item.color }}
                  </span>
                }
                @if (item.size) {
                  <span class="item-size">{{ item.size }}</span>
                }
              </div>
              <div class="item-bottom">
                <div class="quantity-selector">
                  <button
                    class="qty-btn minus"
                    (click)="decrementItem(item)"
                    [disabled]="item.quantity <= 1"
                  >
                    <i class="bi bi-dash"></i>
                  </button>
                  <span class="qty-value">{{ item.quantity }}</span>
                  <button class="qty-btn plus" (click)="incrementItem(item)">
                    <i class="bi bi-plus"></i>
                  </button>
                </div>
                <span class="item-price">${{ (item.price * item.quantity).toFixed(2) }}</span>
              </div>
            </div>
          </div>
        }
      </div>

      <div class="cart-summary">
        <div class="coupon-section">
          @if (!cartService.appliedCoupon()) {
            <div class="coupon-input-wrapper">
              <input
                type="text"
                placeholder="كود الخصم"
                class="coupon-input"
                [(ngModel)]="couponInput"
                (keyup.enter)="applyCoupon()"
              />
              <button
                class="coupon-btn"
                (click)="applyCoupon()"
                [disabled]="!couponInput.trim() || cartService.isLoading()"
              >
                تطبيق
              </button>
            </div>
          } @else {
            <div class="applied-coupon">
              <span>
                <i class="bi bi-check-circle-fill text-success"></i>
                {{ cartService.appliedCoupon() }}
              </span>
              <button class="remove-coupon-btn" (click)="removeCoupon()">
                <i class="bi bi-x"></i>
              </button>
            </div>
          }
          @if (cartService.error()) {
            <small class="text-danger">{{ cartService.error() }}</small>
          }
        </div>

        <div class="summary-details">
          <div class="summary-row">
            <span>المجموع الفرعي</span>
            <span>${{ cartService.subtotal().toFixed(2) }}</span>
          </div>
          <div class="summary-row">
            <span>الشحن</span>
            <span class="shipping-value">${{ cartService.shippingCost().toFixed(2) }}</span>
          </div>
          @if (cartService.discountAmount() > 0) {
            <div class="summary-row discount">
              <span>
                <i class="bi bi-tag-fill"></i>
                الخصم
              </span>
              <span>-${{ cartService.discountAmount().toFixed(2) }}</span>
            </div>
          }
          <div class="summary-row total">
            <span>الإجمالي</span>
            <span>${{ cartService.total().toFixed(2) }}</span>
          </div>
        </div>

        <button class="checkout-btn" routerLink="/checkout" data-bs-dismiss="offcanvas">
          <span>إتمام الشراء</span>
          <i class="bi bi-arrow-left"></i>
        </button>

        <a href="#" class="continue-shopping" data-bs-dismiss="offcanvas">
          <i class="bi bi-arrow-right"></i>
          متابعة التسوق
        </a>
      </div>
    }
  </div>
</div>
